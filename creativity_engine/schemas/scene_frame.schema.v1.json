{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "keystone://creativity-engine/schema/scene_frame.v1.json",
  "title": "Creativity Engine - SceneFrame (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "scene_id",
    "chapter_index",
    "scene_index",
    "frame",
    "generated"
  ],
  "properties": {
    "schema_version": { "type": "string", "const": "scene_frame.v1" },
    "scene_id": { "type": "string", "format": "uuid" },
    "chapter_index": { "type": "integer", "minimum": 0 },
    "scene_index": { "type": "integer", "minimum": 0 },

    "frame": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "escalation_tier",
        "identity_tension",
        "thematic_stress",
        "relational_friction",
        "canon_constraints",
        "choice_gate"
      ],
      "properties": {
        "escalation_tier": { "type": "string", "enum": ["A1", "A2", "A3", "B1", "B2", "B3"] },
        "identity_tension": { "type": "integer", "minimum": 0, "maximum": 100 },
        "thematic_stress": { "type": "integer", "minimum": 0, "maximum": 100 },
        "relational_friction": { "type": "integer", "minimum": 0, "maximum": 100 },

        "canon_constraints": {
          "type": "object",
          "additionalProperties": false,
          "required": ["must_include_callbacks", "forbidden"],
          "properties": {
            "must_include_callbacks": {
              "type": "array",
              "maxItems": 12,
              "items": { "type": "string", "minLength": 1, "maxLength": 140 }
            },
            "forbidden": {
              "type": "array",
              "maxItems": 24,
              "items": { "type": "string", "minLength": 1, "maxLength": 140 }
            }
          }
        },

        "choice_gate": { "$ref": "#/$defs/ChoiceGate" }
      }
    },

    "generated": {
      "type": "object",
      "additionalProperties": false,
      "required": ["prose", "summary", "key_events"],
      "properties": {
        "prose": { "type": "string", "minLength": 1, "maxLength": 60000 },
        "summary": { "type": "string", "minLength": 1, "maxLength": 800 },
        "key_events": {
          "type": "array",
          "minItems": 1,
          "maxItems": 20,
          "items": { "type": "string", "minLength": 4, "maxLength": 240 }
        }
      }
    }
  },
  "$defs": {
    "ChoiceGate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "prompt": { "type": "string", "maxLength": 240 },
        "options": {
          "type": "array",
          "maxItems": 6,
          "items": { "$ref": "#/$defs/ChoiceOption" }
        },
        "selected_index": { "type": "integer", "minimum": 0 }
      },
      "allOf": [
        {
          "if": { "properties": { "enabled": { "const": true } }, "required": ["enabled"] },
          "then": { "required": ["prompt", "options"] }
        }
      ]
    },
    "ChoiceOption": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text", "weight"],
      "properties": {
        "text": { "type": "string", "minLength": 2, "maxLength": 160 },
        "weight": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "consequence_hint": { "type": "string", "maxLength": 240 }
      }
    }
  }
}